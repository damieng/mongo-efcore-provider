/* Copyright 2023-present MongoDB Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Diagnostics;
using Microsoft.EntityFrameworkCore.Infrastructure;
using MongoDB.Bson.Serialization.Attributes;
using MongoDB.Driver;
using MongoDB.EntityFrameworkCore.Extensions;

namespace MongoDB.EntityFrameworkCore.FunctionalTests.Compatibility;

[XUnitCollection("Vectors")]
public class VectorApiTests(TemporaryDatabaseFixture database)
    : IClassFixture<TemporaryDatabaseFixture>
{
    private readonly double[] _embedding =
    [
        -0.010325509,
        0.067058854,
        0.03915787,
        -0.021280868,
        0.0069551454,
        0.0061711837,
        0.021093253,
        0.03277897,
        -0.057195682,
        0.033717044,
        0.020369597,
        -0.04872622,
        0.052746534,
        -0.019069694,
        0.010003884,
        0.03982792,
        0.0014045977,
        -0.0095013445,
        -0.002028584,
        -0.012194956,
        0.036424056,
        0.012965516,
        0.029830739,
        -0.019485127,
        0.032510947,
        -0.001887873,
        0.016858522,
        0.08839333,
        0.06914942,
        -0.05778533,
        0.014365926,
        -0.037951775,
        -0.022915797,
        0.02283539,
        0.015022578,
        0.017555377,
        0.0027790428,
        0.01646989,
        0.025944434,
        0.0025277731,
        0.00051845313,
        0.0045563574,
        0.015223593,
        -0.043794632,
        0.020061372,
        -0.014473135,
        -0.011477999,
        -0.039265078,
        -0.025529,
        -0.0075983955,
        0.0025227477,
        0.008710682,
        -0.0523177,
        0.03728172,
        0.020382999,
        0.008985404,
        -0.018841878,
        -0.0010335561,
        0.034360293,
        0.02578362,
        -0.004261534,
        -0.011008963,
        0.012965516,
        0.002361935,
        -0.044893518,
        0.013106228,
        -0.035646796,
        0.024577526,
        0.004757373,
        -0.011826427,
        -0.0011734295,
        0.0057088477,
        0.038514618,
        -0.0036149335,
        0.025073366,
        -0.0151565885,
        0.0014942171,
        0.04384824,
        0.011786224,
        0.0074174814,
        -0.003507725,
        0.0280618,
        0.040417567,
        -0.019351117,
        -0.037147712,
        -0.036906492,
        -0.0016860197,
        0.016992532,
        0.013320644,
        -0.042159706,
        -0.059125435,
        0.031224448,
        0.024202297,
        0.00943434,
        0.055051517,
        0.045134738,
        0.013488158,
        -0.014004098,
        -0.03406547,
        0.016885323,
        -0.050843585,
        -0.028597841,
        0.038246598,
        -0.0031207697,
        0.040873203,
        -0.029026676,
        -0.001799091,
        0.0127645,
        0.020718023,
        0.026654689,
        -0.06786292,
        -0.03610243,
        -0.022955999,
        0.042159706,
        0.025890829,
        -0.009206521,
        -0.03532517,
        -0.051165212,
        -0.0031023433,
        0.03816619,
        -0.020369597,
        0.0024172144,
        0.0165905,
        0.012798003,
        -0.009213222,
        0.028329821,
        0.0038628527,
        -0.03891665,
        0.030554395,
        0.0071360595,
        0.015840042,
        0.0092534255,
        0.03355623,
        -0.02219214,
        -0.06046554,
        0.03942589,
        -0.0408196,
        0.041248433,
        -0.0062951436,
        0.014794759,
        0.016617302,
        0.003047064,
        -0.012087747,
        -0.0053905724,
        -0.078744575,
        -0.010225002,
        -0.012208357,
        0.019994367,
        0.04936947,
        -0.025730018,
        -0.0023937626,
        -0.02232615,
        -0.012174854,
        -0.0018895481,
        -0.027445352,
        -0.038219795,
        -0.01212125,
        0.0002782812,
        -0.02054381,
        0.02577022,
        -0.032993387,
        -0.022701379,
        0.0561236,
        -0.010566728,
        0.00828855,
        -0.028008197,
        -0.046501644,
        0.0045496565,
        -0.0383002,
        -0.020945841,
        0.036692075,
        -0.02705672,
        -0.015612224,
        0.006338697,
        0.027378347,
        -0.007551492,
        0.014352525,
        -0.023773463,
        -0.02972353,
        -0.056981266,
        -0.010426017,
        0.013032522,
        0.039747518,
        0.010211601,
        0.053416587,
        0.021883916,
        0.0068211346,
        -0.010111093,
        -0.023425037,
        0.021723103,
        0.021991124,
        0.047278907,
        0.025957834,
        -0.0034340192,
        0.0280618,
        -0.005779203,
        -0.034923136,
        0.008000427,
        -0.025287783,
        -0.032698564,
        0.0586966,
        -0.047734544,
        -0.012040844,
        0.0014858415,
        -0.042776152,
        -0.04486672,
        -0.011779523,
        0.008442662,
        -0.009709061,
        -0.0523177,
        0.014218515,
        -0.03505715,
        -0.004553007,
        -0.029133884,
        0.00011181502,
        0.0021475183,
        -0.008509667,
        0.046903677,
        -0.011477999,
        -0.022138536,
        -0.0293483,
        0.021347873,
        0.036182836,
        -0.032752167,
        0.000102706486,
        0.01161201,
        0.034655116,
        -0.06995349,
        0.018855277,
        -0.015129786,
        0.04296377,
        0.012730998,
        0.051996075,
        -0.0046233623,
        -0.029428707,
        0.0011315512,
        -0.032591354,
        -0.02755256,
        -0.00081243867,
        -0.005571487,
        -0.02373326,
        -0.05213009,
        0.0069082417,
        0.012724297,
        -0.048029367,
        0.04859221,
        -0.007330375,
        0.021414878,
        0.038058985,
        -0.024121892,
        -0.01811822,
        0.009045709,
        0.011236781,
        -0.004569758,
        0.012456276,
        -0.022044728,
        -0.07788691,
        0.04374103,
        0.009159618,
        -0.005092399,
        -0.02897307,
        -0.010901755,
        0.011719218,
        0.0028862513,
        -0.05623081,
        -0.001415486,
        0.01608126,
        -0.033636637,
        -0.058106955,
        -0.016349282,
        0.020959243,
        0.0036149335,
        0.028088601,
        -0.044464685,
        -0.026587684,
        0.016536897,
        -0.00446255,
        0.045375958,
        0.061430417,
        0.010412617,
        -0.06620119,
        -0.0026567583,
        0.015223593,
        -0.013052623,
        0.02449712,
        -0.008221544,
        0.009347233,
        0.0060170717,
        -0.006569865,
        -0.01570603,
        0.013032522,
        -0.04398225,
        0.002335133,
        -0.03647766,
        -0.01759558,
        0.04682327,
        -0.0072767707,
        -0.0050990996,
        0.022513764,
        -0.0046468144,
        0.090537496,
        0.014553541,
        0.0004962577,
        0.02243336,
        -0.050468355,
        0.03784457,
        0.009735864,
        0.016496694,
        -0.049905512,
        0.03583441,
        0.019083096,
        -0.0073437756,
        0.03545918,
        -0.018265631,
        -0.076010756,
        -0.028651446,
        0.05933985,
        -0.0023401584,
        0.0017488371,
        -0.06914942,
        0.003939909,
        -0.021830311,
        0.056927662,
        -0.021254066,
        -0.036424056,
        -0.026976315,
        -0.007095856,
        -0.0022094983,
        0.031170843,
        -0.027766977,
        0.012617089,
        0.05119201,
        -0.019123299,
        -0.024443517,
        -0.041543256,
        -0.049289063,
        -0.0019029492,
        -0.0084560625,
        -0.027525758,
        -0.0084560625,
        -0.019257309,
        -0.0046836673,
        -0.02192412,
        0.014151509,
        -0.01823883,
        0.009380735,
        -0.009688959,
        0.035137553,
        -0.0072164657,
        0.0058998126,
        -0.032886177,
        -0.0068177846,
        0.0089251,
        -0.01135739,
        -0.012858308,
        -0.050548762,
        -0.0016885324,
        -0.027230935,
        -0.016992532,
        -0.00052264094,
        0.0068948404,
        0.020315992,
        0.020262389,
        0.0025076715,
        -0.004408946,
        0.014714354,
        -0.010399215,
        0.011967138,
        -0.003417268,
        0.0009623629,
        -0.004479301,
        -0.004743972,
        -0.06941744,
        0.02078503,
        0.0066502714,
        0.016885323,
        0.003368689,
        0.026989715,
        0.055533953,
        0.061698437,
        0.020758227,
        -0.020972645,
        -0.0471985,
        -0.06872059,
        0.01940472,
        0.020637618,
        -0.009039009,
        0.0037489438,
        -0.058374975,
        0.022259144,
        0.028410228,
        -0.032484148,
        0.039533097,
        -0.0055915886,
        -0.0035412277,
        0.015625624,
        0.017501771,
        0.043285392,
        0.015169989,
        -0.0049014343,
        -0.008844693,
        -0.05170125,
        -0.029375102,
        0.020584013,
        -0.007705604,
        0.015773036,
        0.012349068,
        0.07322334,
        0.049637493,
        0.0014112982,
        -0.033100594,
        0.013179933,
        0.03328821,
        0.0038494517,
        -0.0043151383,
        -0.0068211346,
        -0.024322907,
        0.05124562,
        -0.016952328,
        0.059179038,
        0.015545218,
        0.022795187,
        -0.017568776,
        -0.005665294,
        -0.01543801,
        0.035137553,
        0.0331542,
        0.011518203,
        -0.013816483,
        -0.041677266,
        -0.020878837,
        0.020181982,
        -0.028222613,
        0.02500636,
        -0.009186421,
        -0.005078998,
        0.04473271,
        0.00229493,
        0.010881653,
        0.0049918913,
        -0.022821989,
        -0.016295677,
        0.019109897,
        -0.006023772,
        -0.014781359,
        -0.017917205,
        -0.021656098,
        0.035941616,
        0.021026248,
        -0.056177203,
        0.032752167,
        -0.024966158,
        -0.028115405,
        0.017300757,
        0.027740175,
        -0.05296095,
        0.01620187,
        -0.046367634,
        -0.021267466,
        0.012724297,
        0.0015034303,
        0.045992404,
        -0.05052196,
        -0.0019230507,
        0.060626354,
        -0.010734241,
        0.011451198,
        0.03867543,
        0.0484582,
        -0.03508395,
        0.003980112,
        0.0062984936,
        -0.031036833,
        -0.017970808,
        0.00223295,
        -0.015330802,
        0.034494303,
        -0.01440613,
        0.011136273,
        0.0049047843,
        -0.0020001067,
        -0.015518417,
        0.009601853,
        -0.0019046243,
        -0.005524583,
        0.092574455,
        0.01722035,
        -0.0025210725,
        0.04398225,
        0.0052733133,
        -0.02512697,
        0.00061812345,
        0.027351543,
        -0.0154648125,
        -0.041141227,
        0.018774873,
        -0.05038795,
        -0.0019615788,
        0.038568225,
        -0.032082114,
        0.04068559,
        0.012831506,
        -0.026359865,
        0.0057959543,
        0.018171825,
        0.04454509,
        -0.011022364,
        -0.018037815,
        0.049181856,
        0.029937947,
        0.044277072,
        -0.017247152,
        -0.0073906793,
        0.020959243,
        0.014834963,
        0.0035646795,
        -0.0026869106,
        0.002526098,
        -0.036665276,
        -0.017273955,
        0.03468192,
        -0.022232343,
        -0.04221331,
        -0.03240374,
        -0.025971236,
        -0.021602493,
        -0.04808297,
        -0.050843585,
        -0.03647766,
        -0.067755714,
        0.00031115563,
        0.008509667,
        0.007491187,
        0.020047972,
        -0.007323674,
        0.014191712,
        -0.0070087495,
        0.03521796,
        0.007953524,
        0.02105305,
        -0.019511929,
        0.024028083,
        -0.031170843,
        0.012704195,
        -0.020838633,
        0.012798003,
        0.017113142,
        -0.03146567,
        0.0072633694,
        0.039345484,
        0.009340532,
        -0.030715209,
        -0.009843072,
        -0.0004832754,
        0.007484487,
        0.018024413,
        0.007806112,
        -0.033958264,
        -0.011538304,
        -0.014754557,
        -0.031840894,
        -0.0033753896,
        0.04033716,
        -0.012610389,
        -0.013615468,
        0.027217533,
        0.03050079,
        -0.034896336,
        -0.018198626,
        -0.013816483,
        -0.022768386,
        -0.009467842,
        0.015277198,
        -0.044598695,
        -0.01236917,
        0.028490633,
        -0.0318945,
        -0.045456365,
        -0.049155053,
        0.0071762623,
        -0.0077592083,
        0.0007119308,
        -0.0056853956,
        0.017180147,
        -0.020208783,
        -0.0056753447,
        0.0044457987,
        0.038380608,
        0.012831506,
        -0.023840468,
        0.05207648,
        0.020811832,
        -0.0013275415,
        -0.0319213,
        -0.0178502,
        -0.024054885,
        0.029830739,
        -0.038085785,
        -0.011719218,
        -0.010486322,
        0.013421152,
        -0.009789468,
        0.02705672,
        -0.0082684485,
        -0.041757673,
        0.0030303125,
        -0.007946823,
        0.025810422,
        0.020986045,
        0.00472052,
        -0.0073638773,
        -0.016536897,
        -0.0019666043,
        -0.018051215,
        0.0020302592,
        0.011243481,
        -0.026453674,
        -0.0038595025,
        -0.009045709,
        -0.035351973,
        -0.012684095,
        -0.0070355516,
        -0.00060555997,
        0.01759558,
        0.019310914,
        -0.011699117,
        0.018949086,
        -0.04387504,
        -0.0026366566,
        -0.009487944,
        -0.013099527,
        -0.01083475,
        0.043285392,
        0.002284879,
        -0.0056451927,
        -0.0062783924,
        0.019418122,
        0.005625091,
        0.0017957408,
        -0.024818746,
        -0.0062716915,
        0.04757373,
        -0.0123289665,
        -0.047814947,
        0.01722035,
        -0.0433658,
        -0.009682259,
        0.016161667,
        -0.032082114,
        0.011297085,
        -0.04095361,
        -0.010941958,
        0.015223593,
        0.012771201,
        0.0023803615,
        -0.017997611,
        0.0040504676,
        -0.039747518,
        0.018975887,
        0.010493022,
        0.006455956,
        -0.003239704,
        0.015424609,
        -0.03267176,
        -0.0025730017,
        0.04309778,
        0.015987454,
        0.035137553,
        0.020463403,
        0.014580343,
        -0.042534932,
        0.015304,
        0.0018443196,
        0.030581197,
        -0.011766123,
        0.0049717897,
        0.013106228,
        0.00471717,
        0.007832914,
        0.016818319,
        -0.0064727073,
        0.006770881,
        -0.04620682,
        -0.027740175,
        -0.004157676,
        0.010385814,
        -0.0013677448,
        0.022071531,
        0.007752508,
        0.03776416,
        -0.015317401,
        0.014191712,
        0.018774873,
        -0.030795613,
        -0.018654263,
        0.002678535,
        0.012000641,
        0.028115405,
        -0.008784388,
        -0.016938929,
        0.0069484445,
        0.046769667,
        0.02181691,
        -0.06137681,
        -0.0060170717,
        -0.011692417,
        0.0114847,
        0.0060103713,
        0.027954591,
        0.016912125,
        0.017247152,
        0.015196791,
        -0.0047138194,
        0.014888567,
        -0.0064760577,
        0.015424609,
        0.01287841,
        -0.015665827,
        -0.025086766,
        -0.020195384,
        -0.049557086,
        0.030768812,
        -0.01848005,
        -0.0497447,
        -0.0070824553,
        -0.0070087495,
        -0.029187487,
        0.00957505,
        0.016295677,
        0.006137681,
        0.010861551,
        0.020852035,
        0.020128379,
        0.025274381,
        0.04416986,
        -0.013039222,
        -0.032108918,
        -0.009876574,
        -0.03773736,
        -0.031197645,
        -0.003547928,
        0.009099313,
        -0.025730018,
        0.002512697,
        -0.04272255,
        0.03304699,
        -0.009099313,
        -0.017153345,
        -0.00930703,
        -0.011524904,
        -0.03843421,
        0.011129572,
        -0.001837619,
        -0.02449712,
        -0.016791517,
        -0.020570613,
        0.0039734114,
        0.017568776,
        -0.010761044,
        -0.009910077,
        0.009240025,
        0.035861213,
        -0.04044437,
        0.02002117,
        0.018962486,
        -0.0080875335,
        -0.008355555,
        0.004435748,
        -0.02629286,
        0.0034909737,
        0.00048411294,
        0.014017499,
        0.024269303,
        0.008141139,
        0.03645086,
        0.005970168,
        0.01467415,
        0.00016657087,
        -0.00053017907,
        0.038889848,
        -0.023277625,
        0.007122658,
        -0.0008262585,
        -0.022768386,
        -0.028490633,
        0.011685716,
        -0.00472387,
        0.013186634,
        0.0042313817,
        -0.043070976,
        -0.013689173,
        0.00057959545,
        -0.024001282,
        0.0021475183,
        0.02540839,
        0.005410674,
        0.022862192,
        -0.05025394,
        0.011759422,
        0.025837226,
        0.01287841,
        0.02219214,
        0.0064526056,
        0.026319664,
        0.031224448,
        0.039131068,
        -0.0043184888,
        -0.00804063,
        -0.013334045,
        -0.017381163,
        -0.020302592,
        0.020476805,
        0.015545218,
        0.020235587,
        0.007249968,
        -0.005537984,
        -0.016979132,
        -0.023170417,
        0.026359865,
        0.008241646,
        0.018828476,
        0.021723103,
        -0.007323674,
        0.015840042,
        0.011685716,
        0.0072164657,
        0.00395666,
        -0.015317401,
        -0.015625624,
        0.012148052,
        0.070489526,
        0.012871709,
        -0.010700739,
        0.03406547,
        -0.019632539,
        -0.0025981287,
        0.005266613,
        -0.016603902,
        -0.04808297,
        -0.022982802,
        -0.024028083,
        0.013615468,
        0.0006101666,
        -0.009762665,
        -0.013293842,
        0.010526525,
        -0.004197879,
        0.033609834,
        -0.0051594046,
        -0.027659768,
        -0.025140371,
        0.009474543,
        0.019431524,
        0.011156375,
        0.045885198,
        -0.00044516614,
        -0.002933155,
        -0.031974908,
        -0.035914816,
        0.0010754343,
        -0.04923546,
        0.018198626,
        -0.035754003,
        -0.003876254,
        -0.003331836,
        0.0037087407,
        0.01709974,
        0.005702147,
        0.0076251975,
        -0.050173532,
        0.060947977,
        0.054783493,
        -0.02259417,
        0.007229867,
        -0.021374676,
        0.005001942,
        -0.024952756,
        0.033395417,
        -0.016737912,
        -0.02819581,
        0.010345611,
        -0.014124707,
        -0.00065288245,
        -0.019042892,
        -0.033904657,
        -0.018547054,
        -0.027190732,
        0.027820582,
        -0.002246351,
        0.010700739,
        0.047895353,
        0.030071957,
        -0.027137127,
        0.00070188,
        -0.028999873,
        -0.0062180874,
        -0.012844907,
        0.06545073,
        0.012784602,
        0.0446523,
        -0.0028426978,
        -0.010057488,
        0.016644105,
        0.011605309,
        -0.031626478,
        0.0130057195,
        0.016416287,
        0.023505442,
        0.030634802,
        -0.016255474,
        -0.035485983,
        0.014325723,
        0.009112715,
        -0.008603474,
        0.016349282,
        0.006030473,
        -0.030688405,
        0.009186421,
        -0.0010427693,
        -0.0031207697,
        0.029696727,
        0.0056217406,
        -0.0018794973,
        0.054408263,
        0.006727327,
        0.018828476,
        -0.01186663,
        -0.015853442,
        0.03797858,
        0.0011533279,
        0.049530283,
        -0.0037221417,
        0.014352525,
        -0.013689173,
        0.022500364,
        -0.010687338,
        0.042508133,
        0.009816269,
        0.012141352,
        -0.017287355,
        0.0057591014,
        0.054274254,
        0.001467415,
        -0.028597841,
        0.017944006,
        -0.047520123,
        0.0027354895,
        -0.011390893,
        -0.030795613,
        -0.005092399,
        0.03867543,
        0.008462763,
        0.050548762,
        0.002308331,
        -0.014861765,
        0.006114229,
        0.037147712,
        -0.0028008195,
        0.02205813,
        0.007940123,
        0.014834963,
        0.010694038,
        0.013910291,
        0.0077659087,
        -0.0036584868,
        -0.013173233,
        0.061805643,
        -0.0012923639,
        -0.039372288,
        -0.019552132,
        0.062288083,
        0.007042252,
        0.018949086,
        0.0357004,
        -0.022245744,
        -0.008837993,
        -0.013963895,
        -0.016389485,
        -0.003648436,
        -0.034976743,
        0.033181,
        0.012308865,
        0.06287773,
        -0.055587556,
        -0.028383425,
        0.025542403,
        0.021120057,
        0.031036833,
        0.00854317,
        0.00075674057,
        0.006600017,
        -0.008992105,
        0.014767958,
        -0.034467503,
        0.022527166,
        0.010861551,
        -0.033904657,
        -0.03154607,
        -0.016255474,
        -0.0045329053,
        0.010493022,
        -0.046635658,
        0.0046769665,
        0.0099301785,
        -0.019230507,
        -0.0075045885,
        0.021254066,
        0.03583441,
        -0.021455081,
        -0.029294696,
        -0.016268875,
        0.004871282,
        0.032323334,
        -0.013977296,
        0.024805345,
        -0.045107935,
        0.015625624,
        -0.026574284,
        -0.012315566,
        0.026842304,
        0.0098095685,
        0.0011080994,
        0.016630704,
        0.013360848,
        0.00867718,
        -0.033985063,
        0.007256669,
        -0.045751188,
        0.036022022,
        0.03556639,
        0.0011734295,
        -0.005501131,
        -0.0047674235,
        -0.0054274253,
        0.0039600106,
        0.035351973,
        -0.02231275,
        -0.024215698,
        -0.02602484,
        0.023492042,
        -0.0034340192,
        0.00084468495,
        -0.0191501,
        0.029669926,
        -0.016094662,
        -0.0076050963,
        0.02524758,
        0.005330268,
        -0.0027589414,
        0.0038125988,
        0.031090437,
        0.012523281,
        -0.023197219,
        0.037201315,
        0.023411635,
        0.011256882,
        -0.0061812345,
        0.029294696,
        -0.028490633,
        0.033877857,
        0.0019046243,
        0.009983783,
        -0.012831506,
        0.0016843445,
        -0.011893433,
        0.0046669156,
        0.015478213,
        0.005182856,
        0.02117366,
        -0.038380608,
        -0.001837619,
        -0.035164356,
        0.020557212,
        -0.025837226,
        -0.007638599,
        0.00676418,
        -0.030313177,
        -0.003635035,
        0.014741155,
        0.038461015,
        0.007933422,
        -0.0048645814,
        -0.024791943,
        0.0017890403,
        0.008255047,
        0.024778543,
        -0.046850074,
        0.01822543,
        0.031814095,
        -0.004429047,
        0.015598822,
        -0.029509114,
        -0.019364517,
        0.003939909,
        -0.02819581,
        0.01326704,
        -0.017944006,
        0.03765695,
        0.027445352,
        0.023693057,
        -0.00017672636,
        0.041677266,
        -0.040122744,
        0.00637555,
        -0.029884342,
        0.0040370664,
        -0.0370405,
        0.04886023,
        0.02205813,
        0.01810482,
        0.014821562,
        -0.026493877,
        0.007846315,
        -0.03074201,
        0.0015645727,
        -0.015076182,
        -0.016603902,
        -0.0084560625,
        0.016751314,
        -0.0045965603,
        -0.0020118328,
        0.0005971843,
        -0.0036283345,
        0.040122744,
        0.016041057,
        -0.032189324,
        -0.0091328155,
        0.0139906965,
        4.172124E-05,
        0.010761044,
        -0.010345611,
        -0.029187487,
        0.012014042,
        -0.0024909202,
        -0.0013635568,
        -0.020892238,
        -0.00522976,
        0.016496694,
        -0.01135739,
        0.03291298,
        0.023492042,
        -0.01772959,
        0.0032614807,
        0.021321071,
        0.048377793,
        -0.0047540227,
        -0.01672451,
        0.0816392,
        0.00035701235,
        -0.028356623,
        0.00086688047,
        0.004784175,
        -0.009762665,
        -0.036933295,
        -0.007960224,
        0.009977082,
        0.0033519377,
        0.0036685376,
        -0.04119483,
        -0.010633733,
        -0.019284112,
        -0.0041643763,
        0.023894073,
        0.015277198,
        0.018319236,
        -0.0051962575,
        -0.02948231,
        0.00024561613,
        0.010251803,
        0.011149674,
        0.00930703,
        -0.009843072,
        -0.018841878,
        -0.016295677,
        -0.004884683,
        0.011464599,
        0.05140643,
        0.020423202,
        -0.0369869,
        -0.013387649,
        0.019820154,
        0.005001942,
        -0.010432717,
        -0.03532517,
        0.019793352,
        0.010526525,
        0.0010444444,
        0.0102049,
        0.0026081793,
        -0.011364091,
        -0.0048377793,
        0.008764287,
        0.004408946,
        0.01835944,
        -0.0063051945,
        0.011049166,
        -0.033636637,
        -0.0067541297,
        0.009923478,
        0.0021843712,
        -0.002207823,
        -0.014982374,
        -0.035780806,
        -0.0025713267,
        -0.04170407,
        -0.01135739,
        0.0002946137,
        -0.04392864,
        0.0110357655,
        -0.014178311,
        -0.009722462,
        0.0029381802,
        -0.04122163,
        -0.039345484,
        -0.011236781,
        0.0027388397,
        -0.017957408,
        -0.0072767707,
        -0.011605309,
        0.0041174726,
        -0.03229653,
        0.05585558,
        0.04272255,
        0.03797858,
        0.019458326,
        -0.023693057,
        0.023880672,
        0.006050574,
        0.03776416,
        -0.031814095,
        0.025917633,
        0.027740175,
        0.00028665684,
        -0.0125768855,
        -0.02016858,
        0.01033221,
        0.011276984,
        -0.024336308,
        0.032189324,
        0.021254066,
        0.036370452,
        -0.027713373,
        0.0031341708,
        0.007156161,
        0.0012915262,
        0.017046137,
        -0.030929625,
        -0.027217533,
        0.060894374,
        -0.036263242,
        0.01301912,
        0.016496694,
        -0.0077123046,
        -0.020838633,
        -0.023639454,
        0.043955445,
        -0.0048042764,
        -0.0051594046,
        0.026855705,
        0.003470872,
        0.026467076,
        -0.023063207,
        0.040926807,
        -0.045268748,
        -0.02154889,
        0.005343669,
        0.0013417802,
        -0.013059324,
        -0.0073035727,
        -0.02741855,
        0.02564961,
        0.04580479,
        -0.014312322,
        0.010318809,
        0.026882507,
        -0.0018392942,
        0.0063587986,
        0.018413043,
        -0.0023887372,
        0.0022647774,
        0.017541975,
        0.048887033,
        0.0071896636,
        0.03165328,
        -0.004874632,
        0.046796467,
        -0.0191367,
        -0.0076721013,
        0.015384406,
        -0.02142828,
        0.0034256435,
        0.019351117,
        -0.016644105,
        0.01735436,
        0.020811832,
        0.02526098,
        -0.0078396145,
        -0.013407751,
        0.036745682,
        -0.015411208,
        0.0025478748,
        0.05714208,
        0.0063051945,
        0.020369597,
        -0.010426017,
        -0.0022161987,
        -0.01709974,
        -0.008094234,
        0.017180147,
        -0.022996202,
        -0.03127805,
        0.003916457,
        -0.010057488,
        -0.004144275,
        -0.013488158,
        -0.026105246,
        0.032484148,
        -0.012925313,
        0.019002689,
        0.007846315,
        -0.011002262,
        -0.022165338,
        -0.028303018,
        -0.018949086,
        0.009849772,
        0.012811405,
        0.024805345,
        -0.00118013,
        -0.02105305,
        -0.009173019,
        -0.011933636,
        0.009997183,
        0.00093556085,
        -0.021254066,
        0.0067842817,
        -0.0178636,
        -0.01823883,
        0.022929197,
        0.0025428494,
        0.026118647,
        -0.0009833021,
        0.031197645,
        0.00957505,
        -0.007323674,
        0.0036919895,
        0.011209979,
        -0.01287841,
        -0.010955359,
        -0.0009690635,
        0.018399643,
        -0.0044223466,
        0.01898929,
        0.0034641717,
        -0.0031743739,
        0.05255892,
        -0.0011365766,
        0.0076587005,
        0.047252104,
        -0.028169008,
        0.042883363,
        0.028731853,
        -0.028034998,
        0.0068948404,
        -0.009508045,
        0.01428552,
        0.019766549,
        -0.02117366,
        0.024309505,
        0.015652427,
        -0.0109151555,
        0.0018275683,
        -0.038997058,
        0.003393816,
        0.015196791,
        -0.016268875,
        0.026359865,
        0.020905638,
        -0.031358458,
        0.016778115,
        0.011156375,
        -0.035244763,
        0.0024540673,
        -0.006137681,
        -0.01759558,
        0.024188897,
        0.047761343,
        0.028490633,
        -0.022768386,
        0.0048411293,
        0.016764713,
        0.0080875335,
        0.044839915,
        0.033743843,
        0.040095944,
        -0.022795187,
        0.010131194,
        0.02448372,
        -0.032832574,
        0.05258572,
        -0.05816056,
        -0.014566942,
        -0.017153345,
        0.015236994,
        -0.008864795,
        0.025046563,
        -0.0034005165,
        -0.018935684,
        0.007940123,
        0.013079425,
        0.03344902,
        0.004174427,
        0.0026048291,
        0.03942589,
        0.0010695714,
        0.036933295,
        -0.0013953844,
        0.01889548,
        0.032082114,
        0.009615254,
        0.047278907,
        -0.019498529,
        -0.02577022,
        -0.023438437,
        0.03468192,
        -0.010432717,
        0.008844693,
        0.020114977,
        -0.005548035,
        -0.021910718,
        -0.0053503695,
        -0.01811822,
        0.014566942,
        0.012335667,
        -0.040497974,
        0.005373821,
        0.023947677,
        0.01977995,
        0.022379754,
        -0.00086688047,
        0.0293215,
        0.004120823,
        -0.0369869,
        -0.017448168,
        0.00044935397,
        0.028624645,
        -0.035137553,
        0.008301951,
        -0.0012111199,
        0.014995775,
        0.048645813,
        -0.002015183,
        -0.020637618,
        0.019538732,
        -0.0009958656,
        0.022500364,
        0.007940123,
        0.035619993,
        -0.011980539,
        -0.023331229,
        0.00018635836,
        0.022620974,
        -0.015920447,
        0.038836244,
        0.020181982,
        0.06716607,
        -0.0055145323,
        0.022915797,
        0.027900986,
        -0.016657505,
        -0.0017438116,
        0.026882507,
        0.065236315,
        -0.019967565,
        -0.05062917,
        -0.0009514746,
        0.018332638,
        0.0061175795,
        0.026641289,
        0.012315566,
        -0.00029817337,
        0.020597415,
        -0.014339124,
        -0.0030939674,
        0.010740942,
        0.041248433,
        -0.0015804864,
        -0.025100168,
        -0.02792779,
        0.033717044,
        -0.012409373,
        -0.008194743,
        0.017206948,
        0.025971236,
        -0.000379836,
        -0.0013451305,
        -0.0019146751,
        -0.0002753497,
        -0.004274935,
        -0.0019733047,
        -0.023773463,
        0.023532245,
        -0.008938501,
        -0.010198199,
        -0.0018108169,
        0.020945841,
        -0.0071628615,
        -0.008523068,
        0.020852035,
        0.017877001,
        -0.0012261961,
        0.00044307223,
        -0.009963681,
        -0.024443517,
        -0.045724384,
        -0.015223593,
        -0.045375958,
        -0.014124707,
        0.0071360595,
        0.035646796,
        0.008389058,
        0.00880449,
        0.005330268,
        -0.028999873,
        -0.01990056,
        0.048190176,
        -0.058750205,
        -0.036933295,
        0.01735436,
        0.00092299737,
        0.015330802,
        -0.008382357,
        -0.021347873,
        0.012737699,
        0.009119415,
        0.019887159,
        0.0010796222
    ];

    [Fact]
    public async Task Can_query_using_vector_search()
    {
        var optionsBuilder = For(database.MongoDatabase);
        var db = new KnowledgeBaseContext(optionsBuilder.Options);

        var vectorOptions = new VectorSearchOptions<Article> {IndexName = "vector_index",};

        var results = await db.Articles.VectorSearch(a => a.ContentEmbedding, _embedding, 10, vectorOptions).ToListAsync();
    }

    public class KnowledgeBaseContext(DbContextOptions options)
        : DbContext(options)
    {
        public DbSet<Article> Articles { get; set; }

        protected override void OnModelCreating(ModelBuilder mb)
        {
            base.OnModelCreating(mb);

            mb.Entity<Article>(a =>
                {
                    a.ToCollection("articles");
                    a.Property(y => y.Score).HasElementName("score");
                    a.HasKey(y => y.Id);
                }
            );
        }
    }

    public static DbContextOptionsBuilder<KnowledgeBaseContext> For(IMongoDatabase mongoDatabase) =>
        new DbContextOptionsBuilder<KnowledgeBaseContext>()
            .UseMongoDB(mongoDatabase.Client, mongoDatabase.DatabaseNamespace.DatabaseName)
            .ConfigureWarnings(x => x.Ignore(CoreEventId.ManyServiceProvidersCreatedWarning))
            .ReplaceService<IModelCacheKeyFactory, IgnoreCacheKeyFactory>();

    public class Article
    {
        [BsonId]
        public Guid Id { get; set; } = Guid.NewGuid();

        public string Title { get; set; }
        public string Category { get; set; }
        public string Content { get; set; }

        // Vector embedding for the article content
        public float[] ContentEmbedding { get; set; }

        public float? Score { get; set; }
    }
}
